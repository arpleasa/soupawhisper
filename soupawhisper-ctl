#!/bin/bash
# SoupaWhisper Control CLI

SERVICE="soupawhisper"
CONFIG_FILE="$HOME/.config/soupawhisper/config.ini"

get_current_model() {
    if [[ -f "$CONFIG_FILE" ]]; then
        model=$(grep -E "^model\s*=" "$CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
        echo "${model:-base.en}"
    else
        echo "base.en"
    fi
}

get_current_hotkey() {
    if [[ -f "$CONFIG_FILE" ]]; then
        key=$(grep -E "^key\s*=" "$CONFIG_FILE" 2>/dev/null | cut -d'=' -f2 | tr -d ' ')
        echo "${key:-f12}"
    else
        echo "f12"
    fi
}

set_hotkey() {
    local key="$1"

    if [[ -f "$CONFIG_FILE" ]]; then
        if grep -q "^\[hotkey\]" "$CONFIG_FILE"; then
            sed -i "s|^key\s*=.*|key = $key|" "$CONFIG_FILE"
        else
            cat >> "$CONFIG_FILE" << EOF

[hotkey]
key = $key
EOF
        fi
    fi
}

show_hotkey_menu() {
    echo ""
    echo "======== Select Hotkey ========"
    echo ""
    echo "  Current: $(get_current_hotkey)"
    echo ""
    echo "  --- Function Keys ---"
    echo "  1) F12  (default)"
    echo "  2) F11"
    echo "  3) F10"
    echo "  4) F9"
    echo "  5) F8"
    echo ""
    echo "  --- Special Keys ---"
    echo "  6) Scroll Lock"
    echo "  7) Pause"
    echo "  8) Insert"
    echo ""
    echo "  c) Custom key"
    echo "  b) Back"
    echo ""
}

select_hotkey() {
    while true; do
        show_hotkey_menu
        read -p "Select hotkey: " choice

        case $choice in
            1) set_hotkey "f12" ;;
            2) set_hotkey "f11" ;;
            3) set_hotkey "f10" ;;
            4) set_hotkey "f9" ;;
            5) set_hotkey "f8" ;;
            6) set_hotkey "scroll_lock" ;;
            7) set_hotkey "pause" ;;
            8) set_hotkey "insert" ;;
            c|C)
                echo ""
                read -p "Enter key name (e.g., f7, home, end): " custom_key
                if [[ -n "$custom_key" ]]; then
                    set_hotkey "$custom_key"
                else
                    echo "No key entered."
                    continue
                fi
                ;;
            b|B) return ;;
            *) echo "Invalid option."; continue ;;
        esac

        echo ""
        echo "Hotkey set to: $(get_current_hotkey)"
        echo ""
        read -p "Restart service to apply? (y/n): " restart
        if [[ "$restart" == "y" || "$restart" == "Y" ]]; then
            systemctl --user restart $SERVICE
            echo "Service restarted."
        fi
        return
    done
}

set_model() {
    local model="$1"

    if [[ -f "$CONFIG_FILE" ]]; then
        sed -i "s|^model\s*=.*|model = $model|" "$CONFIG_FILE"
    fi
}

show_status() {
    echo ""
    systemctl --user status $SERVICE --no-pager 2>/dev/null | head -5
    echo ""
}

show_model_menu() {
    echo ""
    echo "======== Select Whisper Model ========"
    echo ""
    echo "  Current: $(get_current_model)"
    echo ""
    echo "  1) tiny.en     (fastest, ~75MB)"
    echo "  2) base.en     (fast, good quality)"
    echo "  3) small.en    (medium speed, better)"
    echo "  4) medium.en   (slower, great)"
    echo "  5) large-v3    (slowest, best)"
    echo ""
    echo "  b) Back"
    echo ""
}

select_model() {
    while true; do
        show_model_menu
        read -p "Select model: " choice

        case $choice in
            1) set_model "tiny.en" ;;
            2) set_model "base.en" ;;
            3) set_model "small.en" ;;
            4) set_model "medium.en" ;;
            5) set_model "large-v3" ;;
            b|B) return ;;
            *) echo "Invalid option."; continue ;;
        esac

        echo ""
        echo "Model set to: $(get_current_model)"
        echo ""
        read -p "Restart service to apply? (y/n): " restart
        if [[ "$restart" == "y" || "$restart" == "Y" ]]; then
            systemctl --user restart $SERVICE
            echo "Service restarted."
        fi
        return
    done
}

show_menu() {
    echo "================================"
    echo "   SoupaWhisper Control"
    echo "================================"
    echo ""
    echo "  Model:  $(get_current_model)"
    echo "  Hotkey: $(get_current_hotkey)"
    echo ""
    echo "  1) Start"
    echo "  2) Stop"
    echo "  3) Restart"
    echo "  4) Status"
    echo "  5) Select Model"
    echo "  6) Change Hotkey"
    echo "  7) Enable auto-start"
    echo "  8) Disable auto-start"
    echo "  9) View logs"
    echo "  q) Quit"
    echo ""
}

while true; do
    show_menu
    read -p "Choose an option: " choice

    case $choice in
        1)
            echo "Starting SoupaWhisper..."
            systemctl --user start $SERVICE
            show_status
            ;;
        2)
            echo "Stopping SoupaWhisper..."
            systemctl --user stop $SERVICE
            echo "Stopped."
            ;;
        3)
            echo "Restarting SoupaWhisper..."
            systemctl --user restart $SERVICE
            show_status
            ;;
        4)
            systemctl --user status $SERVICE --no-pager
            ;;
        5)
            select_model
            ;;
        6)
            select_hotkey
            ;;
        7)
            systemctl --user enable $SERVICE
            echo "Auto-start enabled."
            ;;
        8)
            systemctl --user disable $SERVICE
            echo "Auto-start disabled."
            ;;
        9)
            journalctl --user -u $SERVICE -n 30 --no-pager
            ;;
        q|Q)
            echo "Bye!"
            exit 0
            ;;
        *)
            echo "Invalid option."
            ;;
    esac

    echo ""
    read -p "Press Enter to continue..."
    clear
done
